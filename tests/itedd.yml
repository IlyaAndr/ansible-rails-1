---
- hosts: all
  vars:
    postgresql_encoding: 'UTF-8'
    postgresql_locale: 'en_US'
  pre_tasks:
    - apt:
        name: "{{ item }}"
      with_items:
        - locales
        - apt-transport-https

    - file:
        path: '/etc/locale.gen'
        state: 'absent'
    - shell: 'locale-gen "en_US.UTF-8"'

    - name: Create App User
      user:
        name: "{{ app_user }}"
        shell: /bin/bash

  roles:
    - dresden-weekly.Rails/postgresql

    - dresden-weekly.Rails/ruby/rvm
    - dresden-weekly.Rails/ruby/postgresql
    - dresden-weekly.Rails/ruby/sqlite3

    - dresden-weekly.Rails/rails/folders
    - dresden-weekly.Rails/rails/logrotate

    - role: dresden-weekly.Rails/user/profile
      rails_user_name: "{{ app_user }}"
      rails_user_bashrc_lines:
      - "cd {{ RAILS_APP_BASE_PATH }} || true"
      - "cd {{ RAILS_APP_CURRENT_PATH }} || true"
      rails_user_env:
        RAILS_ENV: "{{ rails_env }}"
        SECRET_KEY_BASE: "{{ app_secret_key_base }}"
        RAILS_LOG_FILE_PATH: "{{ RAILS_APP_LOG_PATH }}"
        # DATABASE_URL: "{{ DATABASE_URL }}"

    # - role: ANXS.postgresql
    #   postgresql_databases:
    #     - name: '{{db_name}}'

    - role: dresden-weekly.Rails/upstart/userjobs
      users:
      - "{{ app_user }}"
    - dresden-weekly.Rails/webrick/service
    - dresden-weekly.Rails/nginx/server
    - dresden-weekly.Rails/nginx/webrick

- hosts: all
  become: yes
  become_user: '{{ app_user }}'
  remote_user: '{{ app_user }}'
  vars:
    profile: '/bin/bash -lc -- '

  roles:
  - dresden-weekly.Rails/rails/folders

  - role: dresden-weekly.Rails/rails/create-release
    rails_deploy_custom_archive:
    - Gemfile.lock

  - role: dresden-weekly.Rails/rails/tasks/bundle
  - role: dresden-weekly.Rails/rails/tasks/migrate-database
  - role: dresden-weekly.Rails/rails/tasks/compile-assets
  - role: dresden-weekly.Rails/rails/update-current
  - role: dresden-weekly.Rails/webrick/restart
  - role: dresden-weekly.Rails/rails/cleanup-old-releases
